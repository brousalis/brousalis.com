<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
   <title>Pete Brousalis : http://brousalis.com</title>
   <meta name="author" content="Pete Brousalis" />
   
   <link href="http://feeds2.feedburner.com/brousalis" rel="alternate" title="Pete Brousalis" type="application/atom+xml" />

   <link rel="stylesheet" href="stylesheets/syntax.css" type="text/css" />
   <link rel="stylesheet" href="stylesheets/default.css" type="text/css" />
   

   <script type="text/javascript" src="http://use.typekit.com/fhb0qqm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
   <script src="js/libs/modernizr-1.7.min.js"></script>
</head>
<body> 
  <div id="wrapper">  
    <a href="" class="logo"><img src="images/logo_name.png"></a>    
    <header id="top" class="clearfix">
      <div id="primary"> 
        <ul class="links">
          <li><a href="/about" class="about">About</a><span>About</span></li> 
          <li><a href="/projects" class="projects">Projects</a><span>Projects</span></li> 
          <li><a href="/work" class="work">Work</a><span>Work</span></li> 
          <li><a href="/contact" class="contact">Contact</a><span>Contact</span></li> 
        </ul>       
      </div>
    </header>

    <div id="page">
      <div id="content">
        <article>
  <hgroup>
    <p class="date">2011-04-20 00:00:00 -0500</p>
    <h1>Bare Bones Subversion Backup</h1>
  </hgroup>
  <p><p>This is a basic incremental Subversion backup script. It is meant to be run daily by <a href="http://www.freebsd.org/cgi/man.cgi?query=cron&amp;manpath=FreeBSD+8.0-RELEASE">cron</a>. It requires Ruby. There are many other excellent svn backup scripts out there that do way more than this one. But my goal was just to create something simple and hopefully easy to use. The script checks that a dump of every revision in the repository exists, if not, it dumps the revision and gzips it.</p>

<div class="highlight"><pre><code class="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="c1"># This program writes incremental backups from a Subversion repository to the filesystem</span>

<span class="c1"># Configure the paths to the svn repository and backup directory </span>
<span class="c1"># full paths to the executables are not necessary if they are on the cron user&#39;s $PATH</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:backup_dir</span> <span class="o">=&gt;</span> <span class="s2">&quot;/path/to/backup/&quot;</span><span class="p">,</span> <span class="c1"># Path to backup directory</span>
  <span class="ss">:repos</span>      <span class="o">=&gt;</span> <span class="s2">&quot;/path/to/repos/&quot;</span><span class="p">,</span>  <span class="c1"># Path to SVN repository</span>
  <span class="ss">:svnlook</span>    <span class="o">=&gt;</span> <span class="s2">&quot;svnlook&quot;</span><span class="p">,</span>          <span class="c1"># Path to svnlook executable</span>
  <span class="ss">:svnadmin</span>   <span class="o">=&gt;</span> <span class="s2">&quot;svnadmin&quot;</span><span class="p">,</span>         <span class="c1"># Path to svnadmin executable</span>
  <span class="ss">:gzip</span>       <span class="o">=&gt;</span> <span class="s2">&quot;gzip&quot;</span>              <span class="c1"># Path to gzip executable</span>
<span class="p">}</span>

<span class="c1"># Dumps svn gzipped revisions incrementally.</span>
<span class="k">def</span> <span class="nf">svn_dump</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
  
  <span class="c1"># Start revision</span>
  <span class="n">oldest</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># Get the youngest (most recent) revision</span>
  <span class="n">youngest</span> <span class="o">=</span> <span class="sb">`</span><span class="si">#{</span><span class="n">config</span><span class="o">[</span><span class="ss">:svnlook</span><span class="o">]</span><span class="si">}</span><span class="sb"> youngest </span><span class="si">#{</span><span class="n">config</span><span class="o">[</span><span class="ss">:repos</span><span class="o">]</span><span class="si">}</span><span class="sb">`</span><span class="o">.</span><span class="n">to_i</span>

  <span class="c1"># Save start time</span>
  <span class="n">output</span> <span class="o">=</span> <span class="sb">`date`</span><span class="o">.</span><span class="n">chomp</span> <span class="o">+</span> <span class="s2">&quot; - Subversion backup started</span><span class="se">\n</span><span class="s2">&quot;</span>
  
  <span class="c1"># Check if the revision exists, if not, dump it to the filesystem</span>
  <span class="n">oldest</span><span class="o">.</span><span class="n">upto</span><span class="p">(</span><span class="n">youngest</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">config</span><span class="o">[</span><span class="ss">:backup_dir</span><span class="o">]</span><span class="si">}#{</span><span class="n">i</span><span class="si">}</span><span class="s2">.dump.gz&quot;</span>
      <span class="k">if</span> <span class="nb">system</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">config</span><span class="o">[</span><span class="ss">:svnadmin</span><span class="o">]</span><span class="si">}</span><span class="s2"> dump </span><span class="si">#{</span><span class="n">config</span><span class="o">[</span><span class="ss">:repos</span><span class="o">]</span><span class="si">}</span><span class="s2"> -r </span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2"> --incremental 2&gt;/dev/null | </span><span class="si">#{</span><span class="n">config</span><span class="o">[</span><span class="ss">:gzip</span><span class="o">]</span><span class="si">}</span><span class="s2"> -9 &gt; </span><span class="si">#{</span><span class="n">config</span><span class="o">[</span><span class="ss">:backup_dir</span><span class="o">]</span><span class="si">}#{</span><span class="n">i</span><span class="si">}</span><span class="s2">.dump.gz&quot;</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;* Dumped revision </span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="n">output</span> <span class="o">+=</span> <span class="sb">`date`</span><span class="o">.</span><span class="n">chomp</span> <span class="o">+</span> <span class="s2">&quot; - Subversion backup complete&quot;</span>
<span class="k">end</span>

<span class="c1"># execute dump, writing to stdout for cron</span>
<span class="nb">puts</span> <span class="n">svn_dump</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre>
</div>




</article>

<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
      <li><span>21 Apr 2011</span> &raquo; <a href="/2011/04/21/the-setup/">The Setup</a></li>
    
  </ul>
</div>

<div id="disqus_thread"></div><script type="text/javascript" src="http://disqus.com/forums/brousalis/embed.js"></script><noscript><a href="http://brousalis.disqus.com/?url=ref">View comments.</a></noscript>
 
  
      </div>        
      <aside id="sidebar">
      	<p class="skip"><a href="#posts">Skip to content</a></p>
        <section>
          <p><img class="logo-image" src="images/logo.png" />I'm a software engineering student at <a href="http://rose-hulman.edu">RHIT</a> and aspiring UI developer. I'm a story teller, festival-goer, and Ruby enthusiast. Learn more <a href="#">about me</a>.</p> 
          <div id="diagram"></div>
          <h3>Projects</h3>
          <ul id="projects">
            <li><a href="#">Mobile Trail Mapping</a><span>iOS/Android</span></li>
            <li><a href="#">Never Snooze</a><span>iPhone</span></li>
            <li><a href="#">Alice in Asylum</a><span>Python</span></li>          
            <li><a href="#">Universal Tic Tac Toe</a><span>iOS</span></li>        
          </ul>
          <br />
          <h3>Elsewhere</h3>
          <ul id="social">
            <li class="twitter"><a href="http://twitter.com/brousalis">twitter<strong>/brousalis</strong></a></li>
            <li class="github"><a href="http://github.com/brousalis">github<strong>/brousalis</strong></a></li>
            <li class="facebook"><a href="http://facebook.com/brousapg">facebook<strong>/brousapg</strong></a></li>
            <li class="email"><a href="mailto:brousapg+com@gmail.com">brousapg<strong>@gmail.com</strong></a></li>        
            <li class="rss"><a href="http://feedburner.com/brousalis">rss</a></li>          
          </ul>           
      	</section>
      </aside>
      <div class="clearfix"></div>
    </div>
    
    <footer>
      <div id="bottom">
        <img src="images/logo_white.png" />
        <ul id="bottom-menu">
          <li><a href="/about">About</a></li>
          <li><a href="/projects">Projects</a></li>        
          <li><a href="/work">Work</a></li>        
          <li><a href="/contact">Contact</a></li>        
        </ul>
      </div>
    </footer>  
  </div>
  
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>

  
  <script type="text/javascript" src="js/libs/raphael.js"></script>
  
  <script type="text/javascript">
  //<![CDATA[
  (function() {
  		var links = document.getElementsByTagName('a');
  		var query = '?';
  		for(var i = 0; i < links.length; i++) {
  			if(links[i].href.indexOf('#disqus_thread') >= 0) {
  				query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
  			}
  		}
      document.write('<script type="text/javascript" src="http://disqus.com/forums/brousalis/get_num_replies.js' + query + '"></' + 'script>');
  	})();
  //]]>
  </script>

  <script>
    var _gaq=[["_setAccount","UA-9821208-3"],["_trackPageview"]];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
    s.parentNode.insertBefore(g,s)}(document,"script"));
  </script>

  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script>DD_belatedPNG.fix("img, .png_bg"); // Fix any <img> or .png_bg bg-images. Also, please read goo.gl/mZiyb </script>
  <![endif]-->

</body>
</html>
